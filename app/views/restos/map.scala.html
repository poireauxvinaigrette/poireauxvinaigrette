@scripts = {<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' /><script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js' type="text/javascript"></script>
}
 @main(null, scripts) {

	

	<div id='map'></div>


	<script>
		//var lat, lon = "";
		var geoloc, map, fixedMarker, featureLayer;
		var circle;
		var circle_options = {
			    color: '#fff',      // Stroke color
			    opacity: 1,         // Stroke opacity
			    weight: 10,         // Stroke weight
			    fillColor: '#000',  // Fill color
			    fillOpacity: 0.1    // Fill opacity
			};
		
		var x = document.getElementById("demo");
		map = L.mapbox.map('map', 'poireauxvinaigrette.j3ama3bj');

		featureLayer = L.mapbox.featureLayer().addTo(map);

		function loadRestos(latlng) {

			if (fixedMarker) {
				fixedMarker.setLatLng(latlng);
			} else {
				fixedMarker = L.marker(latlng, {
					icon : L.mapbox.marker.icon({
						'marker-color' : 'ff8888'
					})
				}).addTo(map);
			}

			var fc = fixedMarker.getLatLng();
			distance = (fc.distanceTo(map.getBounds().getNorthWest()));
			dist = (distance * 0.60).toFixed(0);

			console.log("loadRestos: " + dist + "/"
					+ map.getBounds().getCenter());
			uri = '/restos/' + dist + '/' + latlng.lat + '/' + latlng.lng;
			 
			fixedMarker.bindPopup("<a class='popup' href='" +uri + "'>PDJ plus proche</a>");
			
			featureLayer.loadURL(uri + '?format=geojson').addTo(map);
			if (circle) {
				map.removeLayer(circle);
			}
			circle = L.circle(latlng, (distance * 0.48).toFixed(0),circle_options).addTo(map);

		}

		function showError(error) {
			switch (error.code) {
			case error.PERMISSION_DENIED:
				x.innerHTML = "User denied the request for Geolocation."
				break;
			case error.POSITION_UNAVAILABLE:
				x.innerHTML = "Location information is unavailable."
				break;
			case error.TIMEOUT:
				x.innerHTML = "The request to get user location timed out."
				break;
			case error.UNKNOWN_ERROR:
				x.innerHTML = "An unknown error occurred."
				break;
			}
		}
		function showPosition(position) {
			lat = position.coords.latitude;
			lon = position.coords.longitude;
	//		lat = "44.837944";
	//		lon = "-0.5748138";
			map.setView([ lat, lon ], 16);
			//x.innerHTML = lat + "/" + lon;
			var point = new L.LatLng(lat, lon);
			console.log(point.toString());
			loadRestos(point);
		}
		function requestUpdatedPoints(bounds) {
			console.log("moveend:", bounds.getCenter());
			loadRestos(bounds.getCenter());
		}

		$(document)
				.ready(
						function() {
							if (navigator.geolocation) {
								navigator.geolocation.getCurrentPosition(
										showPosition, showError);
							} else {
								x.innerHTML = "Geolocation is not supported by this browser.";
							}
							map.on('dragend', function(e) {
								requestUpdatedPoints(e.target.getBounds())
							});
							map.on('zoomend', function(e) {
								requestUpdatedPoints(e.target.getBounds())
							});

						});
	</script>

}